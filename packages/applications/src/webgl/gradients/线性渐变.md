---
title: 线性渐变
order: 1
nav:
  title: 应用合集
  path: /applications
  order: 5
group:
  title: WebGL
  path: /webgl
  order: 3
---

# 线性渐变

产生不同颜色的线性渐变

- 参数
  - u_Start ： 起始点
  - u_Mid : 中间值比例（可扩展多个）
  - u_End ： 终点
  - u_ColorStart ： 起始点颜色
  - u_ColorMid ： 中间点颜色（可扩展多个）
  - u_ColorEnd ： 终点颜色
- 原理
  - 求出起始点到终点的向量**modelVec**，并求出该向量的长度**modelLen**和单位向量**modelVec1**
  - 根据中间比例求出中间点的长度**midLen**
  - 按照每个片元，求出起始点到片元点的向量**curVec**,并求出该向量的长度**curLen**,并规整该长度到**0**和**modelLen**之间,求出**curLen**与总长度**modelLen**的比例**curRatio**
  - 根据**curRatio**求出当前片元的所在的左右颜色
  - 根据颜色和比例求出当前片元的颜色插值

## 应用程序

```jsx
/**
 * inline: true
 */
import React from 'react';
import { Webgl } from '@bestlyg/applications';
export default Webgl.LineGradients;
```

## [核心代码](https://gitee.com/bestlyg/bestlyg/tree/master/packages/applications/src/webgl/gradients/LineGradients.tsx)

```ts
import React, { useRef, useEffect, useState } from 'react';
import { Poly, Webgl } from '@bestlyg/webgl';
import styles from './styles.less';
import { Color } from 'three';
import { Space, InputNumber, Row } from 'antd';
const vertexShaderSource = `
attribute vec4 a_Position;
void main(){
    gl_Position=a_Position;
}
`;
const fragmentShaderSource = `
precision mediump float;
uniform vec2 u_Start;
uniform vec2 u_End;
uniform float u_Mid;
uniform vec4 u_ColorStart;
uniform vec4 u_ColorMid;
uniform vec4 u_ColorEnd;

vec2 modelVec = u_End - u_Start;
float modelLen = length(modelVec);
vec2 modelVec1 = normalize(modelVec);
float midLen = modelLen * u_Mid;

void main(){
  vec2 curVec = vec2(gl_FragCoord) - u_Start;
  float curLen = clamp( dot(curVec,modelVec1) , 0.0 , modelLen );
  float curRatio = curLen / modelLen;
  vec4 color;
  if(curRatio <= u_Mid){
    float ratio = curRatio / u_Mid;
    color = u_ColorStart + ( u_ColorMid - u_ColorStart ) * ratio ;
  } else {
    float ratio = (curRatio - u_Mid) / (1.0 - u_Mid);
    color = u_ColorMid + ( u_ColorEnd - u_ColorMid ) * ratio ;
  }
  gl_FragColor = color;
}
`;
/** 画布宽高 */
const CANVAS_SIZE = 300;
const colorList = [
  { label: '起点颜色', key: 'u_ColorStart' },
  { label: '中间颜色', key: 'u_ColorMid' },
  { label: '终点颜色', key: 'u_ColorEnd' },
];
const colorItemList = ['红', '绿', '蓝', '透明度'];
const posList = [
  { label: '起点位置', key: 'u_Start' },
  { label: '终点位置', key: 'u_End' },
];
const posItemList = ['X', 'Y'];
export default function LineGradients() {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const webglRef = useRef<Webgl>();
  const polyRef = useRef<Poly>();
  const [data, setData] = useState<Record<string, number[]>>({
    u_ColorStart: [...new Color('#FAD961').toArray(), 1],
    u_ColorMid: [...new Color('#F76B1C').toArray(), 1],
    u_ColorEnd: [...new Color('#EA3333').toArray(), 1],
    u_Start: [0, 0],
    u_Mid: [0.5],
    u_End: [CANVAS_SIZE, CANVAS_SIZE],
  });
  useEffect(() => {
    webglRef.current = new Webgl({ canvas: canvasRef.current!, size: [300, 300] });
    polyRef.current = new Poly({
      webgl: webglRef.current,
      vertexShaderSource,
      fragmentShaderSource,
      data: [-1, 1, -1, -1, 1, 1, 1, -1],
      drawTypes: ['TRIANGLE_STRIP'],
      attributes: [{ name: 'a_Position', size: 2 }],
      uniforms: [
        { name: 'u_Start', data: data.u_Start, method: 'uniform2fv' },
        { name: 'u_Mid', data: data.u_Mid, method: 'uniform1fv' },
        {
          name: 'u_End',
          data: data.u_End,
          method: 'uniform2fv',
        },
        {
          name: 'u_ColorStart',
          data: data.u_ColorStart,
          method: 'uniform4fv',
        },
        {
          name: 'u_ColorMid',
          data: data.u_ColorMid,
          method: 'uniform4fv',
        },
        {
          name: 'u_ColorEnd',
          data: data.u_ColorEnd,
          method: 'uniform4fv',
        },
      ],
    });
    polyRef.current.draw();
  }, []);
  useEffect(() => {
    const poly = polyRef.current;
    if (!poly) return;
    Object.entries(data).forEach(([k, v]) => {
      poly.uniformMap[k]!.data = v;
    });
    poly.updateUniforms();
    poly.draw();
  }, [data]);
  return (
    <Space direction="vertical" className={styles.container}>
      {colorList.map((v, i) => (
        <Space key={i}>
          {v.label}:
          {colorItemList.map((label, j) => (
            <Space key={j}>
              {label} :
              <InputNumber
                style={{ width: 120 }}
                min={0}
                max={255}
                value={data[v.key][j] * 255}
                // formatter={value => `${label}： ${value}`}
                onChange={e => {
                  const color = data[v.key];
                  color[j] = e / 255;
                  setData({ ...data, [v.key]: color });
                }}
              />
            </Space>
          ))}
        </Space>
      ))}
      {posList.map((v, i) => (
        <Space key={i}>
          {v.label}[左下角为(0,0)最大300]:
          {posItemList.map((label, j) => (
            <Space key={j}>
              {label} :
              <InputNumber
                step={1}
                style={{ width: 120 }}
                min={0}
                max={300}
                value={data[v.key][j]}
                // formatter={value => `${label}： ${value}`}
                onChange={e => {
                  const pos = data[v.key];
                  pos[j] = e;
                  setData({ ...data, [v.key]: pos });
                }}
              />
            </Space>
          ))}
        </Space>
      ))}
      <Space>
        中间位置比例(0~1):
        <InputNumber
          step={0.01}
          style={{ width: 120 }}
          min={0}
          max={1}
          value={data.u_Mid[0]}
          onChange={e => {
            setData({ ...data, u_Mid: [e] });
          }}
        />
      </Space>
      <canvas ref={canvasRef} />
    </Space>
  );
}
```
