class Solution:
    def maxProduct(self, root: Optional[TreeNode]) -> int:
        if not root: return 1
        nodes = {}
        def dfs(node: Optional[TreeNode]) -> int:
            if not node: return 0
            lval = dfs(node.left)
            rval = dfs(node.right)
            nodes[node] = [lval, rval]
            return lval + rval + node.val
        val = dfs(root)
        res = 0
        def dfs2(node: Optional[TreeNode]) -> int:
            nonlocal res
            if not node: return 1
            res = max(res,
                nodes[node][0] * (val - nodes[node][0]), 
                (val - nodes[node][1]) * nodes[node][1] )
            dfs2(node.left)
            dfs2(node.right)
        dfs2(root)
        return res % (10 ** 9 + 7)